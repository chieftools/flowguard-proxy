{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://github.com/chieftools/flowguard/config.schema.json",
    "title": "FlowGuard Configuration",
    "description": "Configuration schema for FlowGuard reverse proxy security rules",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "JSON Schema reference for IDE validation and autocomplete"
        },
        "id": {
            "type": "string",
            "format": "ulid",
            "description": "Unique identifier for this configuration version"
        },
        "host": {
            "$ref": "#/definitions/host"
        },
        "rules": {
            "type": "object",
            "description": "Security rules that define when to take actions",
            "patternProperties": {
                "^[a-zA-Z0-9_-]+$": {
                    "$ref": "#/definitions/rule"
                }
            },
            "additionalProperties": false
        },
        "actions": {
            "type": "object",
            "description": "Actions that can be taken when rules match",
            "patternProperties": {
                "^[a-zA-Z0-9_-]+$": {
                    "$ref": "#/definitions/action"
                }
            },
            "additionalProperties": false
        },
        "ip_database": {
            "$ref": "#/definitions/ipDatabase"
        },
        "trusted_proxies": {
            "$ref": "#/definitions/trustedProxies"
        },
        "logging": {
            "$ref": "#/definitions/logging"
        },
        "realtime": {
            "$ref": "#/definitions/realtime"
        },
        "cache_dir": {
            "type": "string",
            "description": "Directory for caching external data (IP databases, etc.)"
        },
        "cert_path": {
            "type": "string",
            "description": "Path to SSL certificate files directory"
        }
    },
    "additionalProperties": false,
    "definitions": {
        "host": {
            "type": "object",
            "description": "Host and API configuration",
            "properties": {
                "id": {
                    "type": "string",
                    "format": "ulid",
                    "description": "The server identifier as provided by FlowGuard when registering the host"
                },
                "key": {
                    "type": "string",
                    "description": "The API key for authenticating requests with the FlowGuard API"
                },
                "name": {
                    "type": "string",
                    "description": "The human-readable name of this host"
                },
                "team": {
                    "type": "string",
                    "description": "The team slug this host belongs to"
                },
                "default_hostname": {
                    "type": "string",
                    "description": "Default hostname to use when a certificate is not found"
                }
            },
            "required": [
                "name"
            ],
            "additionalProperties": false
        },
        "rule": {
            "type": "object",
            "description": "A security rule with conditions and an action",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "The human-readable name of this rule"
                },
                "action": {
                    "type": "string",
                    "description": "The action ID to execute when this rule matches"
                },
                "conditions": {
                    "$ref": "#/definitions/conditions"
                }
            },
            "required": [
                "action",
                "conditions"
            ],
            "additionalProperties": false
        },
        "conditions": {
            "type": "object",
            "description": "Logical conditions for rule matching",
            "properties": {
                "operator": {
                    "type": "string",
                    "enum": [
                        "AND",
                        "OR"
                    ],
                    "description": "Logical operator for combining conditions (default: AND)"
                },
                "groups": {
                    "type": "array",
                    "description": "Nested condition groups",
                    "items": {
                        "$ref": "#/definitions/conditions"
                    }
                },
                "matches": {
                    "type": "array",
                    "description": "Match conditions to evaluate",
                    "items": {
                        "$ref": "#/definitions/match"
                    }
                },
                "comment": {
                    "type": "string",
                    "description": "Optional comment explaining this condition group"
                }
            },
            "additionalProperties": false
        },
        "match": {
            "type": "object",
            "description": "A single match condition",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "domain",
                        "path",
                        "header",
                        "user-agent",
                        "ip",
                        "asn",
                        "as-name",
                        "as-domain",
                        "country",
                        "continent",
                        "ipset"
                    ],
                    "description": "The type of value to match against"
                },
                "match": {
                    "type": "string",
                    "enum": [
                        "equals",
                        "not-equals",
                        "contains",
                        "not-contains",
                        "starts-with",
                        "not-starts-with",
                        "ends-with",
                        "not-ends-with",
                        "in",
                        "not-in",
                        "regex",
                        "not-regex",
                        "exists",
                        "missing"
                    ],
                    "description": "The matching operation to perform"
                },
                "key": {
                    "type": "string",
                    "description": "The header name to match against. Required for 'header' type matches."
                },
                "value": {
                    "type": "string",
                    "description": "The value to match against. Required for most operations except 'in'/'not-in' (use 'values' instead) and 'exists'/'missing'."
                },
                "values": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "List of values for 'in' and 'not-in' operations. Required when match is 'in' or 'not-in'."
                },
                "case_insensitive": {
                    "type": "boolean",
                    "description": "Perform case-insensitive matching (default: false)"
                },
                "raw_match": {
                    "type": "boolean",
                    "description": "Skip URL normalization for path matching to detect malformed URLs (default: false). Only applies to 'path' type matches."
                },
                "family": {
                    "type": "integer",
                    "enum": [
                        4,
                        6
                    ],
                    "description": "IP family for ipset matches (4 for IPv4, 6 for IPv6)"
                }
            },
            "required": [
                "type",
                "match"
            ],
            "additionalProperties": false,
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "header"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "key"
                        ]
                    }
                }
            ]
        },
        "action": {
            "type": "object",
            "description": "An action to take when a rule matches",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "The human-readable name of this action"
                },
                "action": {
                    "type": "string",
                    "enum": [
                        "allow",
                        "block",
                        "rate_limit"
                    ],
                    "description": "The type of action to take"
                },
                "status": {
                    "type": "integer",
                    "minimum": 100,
                    "maximum": 599,
                    "description": "HTTP status code to return"
                },
                "message": {
                    "type": "string",
                    "description": "Response message to send"
                },
                "requests_per_window": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Maximum number of requests allowed in the time window (for rate_limit actions)"
                },
                "window_seconds": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Time window in seconds for rate limiting (for rate_limit actions)"
                }
            },
            "required": [
                "action"
            ],
            "additionalProperties": false,
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "action": {
                                "const": "rate_limit"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "requests_per_window",
                            "window_seconds"
                        ]
                    }
                }
            ]
        },
        "ipDatabase": {
            "type": "object",
            "description": "IP geolocation database configuration",
            "properties": {
                "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "URL to download the IP database from"
                },
                "refresh_interval_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "description": "How often to refresh the database in seconds"
                }
            },
            "required": [
                "url"
            ],
            "additionalProperties": false
        },
        "trustedProxies": {
            "type": "object",
            "description": "Trusted proxy configuration for X-Forwarded-For processing",
            "properties": {
                "ipnets": {
                    "type": "array",
                    "description": "List of trusted proxy networks (CIDR notation or URLs)",
                    "items": {
                        "type": "string",
                        "oneOf": [
                            {
                                "pattern": "^https?://",
                                "description": "URL to fetch IP ranges from"
                            },
                            {
                                "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}(/[0-9]{1,2})?$",
                                "description": "IPv4 address or CIDR"
                            },
                            {
                                "pattern": "^[0-9a-fA-F:]+(/[0-9]{1,3})?$",
                                "description": "IPv6 address or CIDR"
                            }
                        ]
                    }
                },
                "refresh_interval_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "description": "How often to refresh IP lists from URLs in seconds"
                }
            },
            "required": [
                "ipnets"
            ],
            "additionalProperties": false
        },
        "logging": {
            "type": "object",
            "description": "Request logging configuration",
            "properties": {
                "file_path": {
                    "type": "string",
                    "description": "Path to log file, leave empty to disable file logging"
                },
                "axiom_token": {
                    "type": "string",
                    "description": "The Axiom API token to send logs to, leave empty to disable Axiom logging"
                },
                "axiom_dataset": {
                    "type": "string",
                    "description": "The Axiom dataset to send logs to, leave empty to disable Axiom logging"
                }
            },
            "additionalProperties": false
        },
        "realtime": {
            "type": "object",
            "description": "WebSocket configuration for real-time messaging",
            "properties": {
                "key": {
                    "type": "string",
                    "description": "WebSocket application key"
                },
                "host": {
                    "type": "string",
                    "description": "Host for the WebSocket server"
                },
                "port": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 65535,
                    "description": "Port for the WebSocket server"
                },
                "channel": {
                    "type": "string",
                    "description": "Channel name to subscribe to for config update notifications (can be public or private)"
                },
                "auth_url": {
                    "type": "string",
                    "format": "uri",
                    "description": "Authentication URL for private channel access. Required for private channels"
                },
                "encrypted": {
                    "type": "boolean",
                    "description": "Whether to use encrypted WebSocket connections (WSS instead of WS). Default: true"
                }
            },
            "required": [
                "key",
                "host",
                "port",
                "channel"
            ],
            "additionalProperties": false
        }
    }
}
