{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://github.com/chieftools/flowguard/config.schema.json",
    "title": "FlowGuard Configuration",
    "description": "Configuration schema for FlowGuard reverse proxy security rules",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "JSON Schema reference for IDE validation and autocomplete"
        },
        "rules": {
            "type": "object",
            "description": "Security rules that define when to take actions",
            "patternProperties": {
                "^[a-zA-Z0-9_-]+$": {
                    "$ref": "#/definitions/rule"
                }
            },
            "additionalProperties": false
        },
        "actions": {
            "type": "object",
            "description": "Actions that can be taken when rules match",
            "patternProperties": {
                "^[a-zA-Z0-9_-]+$": {
                    "$ref": "#/definitions/action"
                }
            },
            "additionalProperties": false
        },
        "ip_database": {
            "$ref": "#/definitions/ipDatabase"
        },
        "trusted_proxies": {
            "$ref": "#/definitions/trustedProxies"
        },
        "logging": {
            "$ref": "#/definitions/logging"
        },
        "cache_dir": {
            "type": "string",
            "description": "Directory for caching external data (IP databases, etc.)"
        },
        "cert_path": {
            "type": "string",
            "description": "Path to SSL certificate files directory"
        },
        "default_hostname": {
            "type": "string",
            "description": "Default hostname to use when a certificate is not found"
        }
    },
    "additionalProperties": false,
    "definitions": {
        "rule": {
            "type": "object",
            "description": "A security rule with conditions and an action",
            "properties": {
                "action": {
                    "type": "string",
                    "description": "The action ID to execute when this rule matches"
                },
                "conditions": {
                    "$ref": "#/definitions/conditions"
                }
            },
            "required": [
                "action",
                "conditions"
            ],
            "additionalProperties": false
        },
        "conditions": {
            "type": "object",
            "description": "Logical conditions for rule matching",
            "properties": {
                "operator": {
                    "type": "string",
                    "enum": [
                        "AND",
                        "OR",
                        "NOT"
                    ],
                    "description": "Logical operator for combining conditions (default: AND)"
                },
                "groups": {
                    "type": "array",
                    "description": "Nested condition groups",
                    "items": {
                        "$ref": "#/definitions/conditions"
                    }
                },
                "matches": {
                    "type": "array",
                    "description": "Match conditions to evaluate",
                    "items": {
                        "$ref": "#/definitions/match"
                    }
                },
                "comment": {
                    "type": "string",
                    "description": "Optional comment explaining this condition group"
                }
            },
            "additionalProperties": false
        },
        "match": {
            "type": "object",
            "description": "A single match condition",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "path",
                        "domain",
                        "host",
                        "agent",
                        "user-agent",
                        "header",
                        "ip",
                        "asn",
                        "ipset"
                    ],
                    "description": "The type of value to match against"
                },
                "match": {
                    "type": "string",
                    "enum": [
                        "equals",
                        "not-equals",
                        "does-not-equal",
                        "contains",
                        "not-contains",
                        "does-not-contain",
                        "starts-with",
                        "not-starts-with",
                        "does-not-start-with",
                        "ends-with",
                        "not-ends-with",
                        "does-not-end-with",
                        "regex",
                        "in",
                        "not-in",
                        "exists",
                        "missing"
                    ],
                    "description": "The matching operation to perform"
                },
                "value": {
                    "type": "string",
                    "description": "The value to match against. Required for most operations except 'in'/'not-in' (use 'values' instead). For 'header' type, this is the header name."
                },
                "values": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "List of values for 'in' and 'not-in' operations. Required when match is 'in' or 'not-in'."
                },
                "case_insensitive": {
                    "type": "boolean",
                    "description": "Perform case-insensitive matching (default: false)"
                },
                "family": {
                    "type": "integer",
                    "enum": [
                        4,
                        6
                    ],
                    "description": "IP family for ipset matches (4 for IPv4, 6 for IPv6)"
                }
            },
            "required": [
                "type",
                "match"
            ],
            "additionalProperties": false
        },
        "action": {
            "type": "object",
            "description": "An action to take when a rule matches",
            "properties": {
                "action": {
                    "type": "string",
                    "enum": [
                        "block"
                    ],
                    "description": "The type of action to take"
                },
                "status": {
                    "type": "integer",
                    "minimum": 100,
                    "maximum": 599,
                    "description": "HTTP status code to return"
                },
                "message": {
                    "type": "string",
                    "description": "Response message to send"
                }
            },
            "required": [
                "action",
                "status",
                "message"
            ],
            "additionalProperties": false
        },
        "ipDatabase": {
            "type": "object",
            "description": "IP geolocation database configuration",
            "properties": {
                "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "URL to download the IP database from"
                },
                "refresh_interval_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "description": "How often to refresh the database in seconds"
                }
            },
            "required": [
                "url"
            ],
            "additionalProperties": false
        },
        "trustedProxies": {
            "type": "object",
            "description": "Trusted proxy configuration for X-Forwarded-For processing",
            "properties": {
                "ipnets": {
                    "type": "array",
                    "description": "List of trusted proxy networks (CIDR notation or URLs)",
                    "items": {
                        "type": "string",
                        "oneOf": [
                            {
                                "pattern": "^https?://",
                                "description": "URL to fetch IP ranges from"
                            },
                            {
                                "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}(/[0-9]{1,2})?$",
                                "description": "IPv4 address or CIDR"
                            },
                            {
                                "pattern": "^[0-9a-fA-F:]+(/[0-9]{1,3})?$",
                                "description": "IPv6 address or CIDR"
                            }
                        ]
                    }
                },
                "refresh_interval_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "description": "How often to refresh IP lists from URLs in seconds"
                }
            },
            "required": [
                "ipnets"
            ],
            "additionalProperties": false
        },
        "logging": {
            "type": "object",
            "description": "Request logging configuration",
            "properties": {
                "file_path": {
                    "type": "string",
                    "description": "Path to log file, leave empty to disable file logging"
                },
                "axiom_token": {
                    "type": "string",
                    "description": "The Axiom API token to send logs to, leave empty to disable Axiom logging"
                },
                "axiom_dataset": {
                    "type": "string",
                    "description": "The Axiom dataset to send logs to, leave empty to disable Axiom logging"
                }
            },
            "additionalProperties": false
        }
    }
}
