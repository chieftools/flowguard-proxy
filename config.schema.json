{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://pkg.flowguard.network/config.schema.json",
    "title": "FlowGuard Proxy Configuration",
    "description": "Configuration schema for FlowGuard reverse proxy security rules",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "JSON Schema reference for IDE validation and autocomplete"
        },
        "id": {
            "type": "string",
            "format": "ulid",
            "description": "Unique identifier for this configuration version"
        },
        "host": {
            "$ref": "#/definitions/host_config"
        },
        "rules": {
            "type": "object",
            "description": "Security rules that define when to take actions",
            "patternProperties": {
                "^[a-zA-Z0-9_-]+$": {
                    "$ref": "#/definitions/rule"
                }
            },
            "additionalProperties": false
        },
        "actions": {
            "type": "object",
            "description": "Actions that can be taken when rules match",
            "patternProperties": {
                "^[a-zA-Z0-9_-]+$": {
                    "$ref": "#/definitions/action"
                }
            },
            "additionalProperties": false
        },
        "logging": {
            "$ref": "#/definitions/logger_config"
        },
        "ip_lists": {
            "$ref": "#/definitions/ip_lists_config"
        },
        "realtime": {
            "$ref": "#/definitions/realtime_config"
        },
        "ip_database": {
            "$ref": "#/definitions/ip_database_config"
        },
        "trusted_proxies": {
            "$ref": "#/definitions/trusted_proxies_config"
        },
        "updates": {
            "$ref": "#/definitions/updates_config"
        }
    },
    "additionalProperties": false,
    "definitions": {
        "host_config": {
            "type": "object",
            "description": "Host and API configuration",
            "properties": {
                "id": {
                    "type": "string",
                    "format": "ulid",
                    "description": "The FlowGuard server identifier"
                },
                "key": {
                    "type": "string",
                    "description": "The FlowGuard API key for authenticating requests"
                },
                "team": {
                    "type": "string",
                    "description": "The FlowGuard team slug this host belongs to"
                },
                "name": {
                    "type": "string",
                    "description": "The human-readable name of this host"
                },
                "cache_path": {
                    "type": "string",
                    "description": "Path to directory for caching remote resources (IP databases, IP lists, etc.)"
                },
                "cert_path": {
                    "type": "string",
                    "description": "Path to directory containing combined SSL certificate+key files. Optional - can be used alone or with nginx_config_path."
                },
                "nginx_config_path": {
                    "type": "string",
                    "description": "Path to NGINX configuration file to parse for SSL certificates. Optional - can be used alone or with cert_path."
                },
                "default_hostname": {
                    "type": "string",
                    "description": "Default hostname to use when a certificate is not found"
                }
            },
            "additionalProperties": false
        },
        "rule": {
            "type": "object",
            "description": "A security rule with conditions and an action",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "The human-readable name of this rule"
                },
                "action": {
                    "type": "string",
                    "description": "The action ID to execute when this rule matches"
                },
                "sort_order": {
                    "type": "integer",
                    "description": "Optional explicit ordering for rule processing. Lower values are processed first. Rules without sort_order are processed after ordered rules, sorted by rule ID."
                },
                "conditions": {
                    "$ref": "#/definitions/conditions"
                }
            },
            "required": [
                "action",
                "conditions"
            ],
            "additionalProperties": false
        },
        "conditions": {
            "type": "object",
            "description": "Logical conditions for rule matching",
            "properties": {
                "operator": {
                    "type": "string",
                    "enum": [
                        "AND",
                        "OR"
                    ],
                    "description": "Logical operator for combining conditions (default: AND)"
                },
                "groups": {
                    "type": "array",
                    "description": "Nested condition groups",
                    "items": {
                        "$ref": "#/definitions/conditions"
                    }
                },
                "matches": {
                    "type": "array",
                    "description": "Match conditions to evaluate",
                    "items": {
                        "$ref": "#/definitions/match"
                    }
                },
                "comment": {
                    "type": "string",
                    "description": "Optional comment explaining this condition group"
                }
            },
            "additionalProperties": false
        },
        "match": {
            "type": "object",
            "description": "A single match condition",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "domain",
                        "path",
                        "header",
                        "user-agent",
                        "ip",
                        "asn",
                        "as-name",
                        "as-domain",
                        "country",
                        "continent",
                        "ipset",
                        "iplist",
                        "registerable-domain"
                    ],
                    "description": "The type of value to match against"
                },
                "match": {
                    "type": "string",
                    "enum": [
                        "equals",
                        "not-equals",
                        "contains",
                        "not-contains",
                        "starts-with",
                        "not-starts-with",
                        "ends-with",
                        "not-ends-with",
                        "in",
                        "not-in",
                        "regex",
                        "not-regex",
                        "exists",
                        "missing"
                    ],
                    "description": "The matching operation to perform"
                },
                "key": {
                    "type": "string",
                    "description": "The header name to match against. Required for 'header' type matches."
                },
                "value": {
                    "type": "string",
                    "description": "The value to match against. Required for most operations except 'in'/'not-in' (use 'values' instead) and 'exists'/'missing'."
                },
                "values": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "List of values for 'in' and 'not-in' operations. Required when match is 'in' or 'not-in'."
                },
                "case_insensitive": {
                    "type": "boolean",
                    "description": "Perform case-insensitive matching (default: false)"
                },
                "raw_match": {
                    "type": "boolean",
                    "description": "Skip URL normalization for path matching to detect malformed URLs (default: false). Only applies to 'path' type matches."
                },
                "confidence": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Minimum confidence level (0-100) required for a match to be considered valid (only applies to IP list matches)"
                },
                "family": {
                    "type": "integer",
                    "enum": [
                        4,
                        6
                    ],
                    "description": "IP family for ipset matches (4 for IPv4, 6 for IPv6)"
                }
            },
            "required": [
                "type",
                "match"
            ],
            "additionalProperties": false,
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "header"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "key"
                        ]
                    }
                }
            ]
        },
        "action": {
            "type": "object",
            "description": "An action to take when a rule matches",
            "properties": {
                "name": {
                    "type": "string",
                    "description": "The human-readable name of this action"
                },
                "action": {
                    "type": "string",
                    "enum": [
                        "log",
                        "allow",
                        "block",
                        "rate_limit"
                    ],
                    "description": "The type of action to take."
                },
                "status": {
                    "type": "integer",
                    "minimum": 100,
                    "maximum": 599,
                    "description": "HTTP status code to return"
                },
                "message": {
                    "type": "string",
                    "description": "Response message to send"
                },
                "requests_per_window": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Maximum number of requests allowed in the time window (for rate_limit actions)"
                },
                "window_seconds": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Time window in seconds for rate limiting (for rate_limit actions)"
                }
            },
            "required": [
                "action"
            ],
            "additionalProperties": false,
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "action": {
                                "const": "rate_limit"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "requests_per_window",
                            "window_seconds"
                        ]
                    }
                }
            ]
        },
        "logger_config": {
            "type": "object",
            "description": "Request logging configuration",
            "properties": {
                "sinks": {
                    "type": "object",
                    "description": "Named logging sinks (destinations). Multiple sinks of the same type can be configured.",
                    "patternProperties": {
                        "^[a-zA-Z0-9_-]+$": {
                            "$ref": "#/definitions/logger_sink"
                        }
                    },
                    "additionalProperties": false
                },
                "header_whitelist": {
                    "type": "array",
                    "description": "List of header names (or prefixes ending with '-') to log values for. If empty, no header values are logged. All header names are always logged regardless of whitelist. The User-Agent header is always logged regardless of this whitelist.",
                    "items": {
                        "type": "string",
                        "examples": [
                            "content-type",
                            "user-agent",
                            "sec-ch-",
                            "cf-"
                        ]
                    }
                }
            },
            "additionalProperties": false
        },
        "logger_sink": {
            "type": "object",
            "description": "A logging sink configuration",
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "file",
                        "axiom",
                        "loki",
                        "openobserve"
                    ],
                    "description": "The type of logging sink"
                },
                "path": {
                    "type": "string",
                    "description": "For file sink: path to the log file"
                },
                "token": {
                    "type": "string",
                    "description": "For axiom sink: Axiom API token"
                },
                "dataset": {
                    "type": "string",
                    "description": "For axiom sink: Axiom dataset name"
                },
                "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "For loki sink: Loki push API URL (e.g., http://loki:3100/loki/api/v1/push). For openobserve sink: OpenObserve base URL (e.g., https://observe.example.com)"
                },
                "organization": {
                    "type": "string",
                    "description": "For openobserve sink: Organization name in OpenObserve"
                },
                "stream": {
                    "type": "string",
                    "description": "For openobserve sink: Stream name (default: flowguard)"
                },
                "labels": {
                    "type": "object",
                    "description": "For loki sink: Static labels to attach to all log entries",
                    "additionalProperties": {
                        "type": "string"
                    }
                },
                "tenant_id": {
                    "type": "string",
                    "description": "For loki sink: Optional X-Scope-OrgID header for multi-tenancy"
                },
                "username": {
                    "type": "string",
                    "description": "For loki sink: Optional basic auth username. For openobserve sink: Basic auth username (typically email)"
                },
                "password": {
                    "type": "string",
                    "description": "For loki sink: Optional basic auth password. For openobserve sink: Basic auth password (API token)"
                }
            },
            "required": [
                "type"
            ],
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "file"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "path"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "axiom"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "token",
                            "dataset"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "loki"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "url"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "openobserve"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "url",
                            "organization"
                        ]
                    }
                }
            ],
            "additionalProperties": false
        },
        "ip_lists_config": {
            "type": "object",
            "description": "In-memory IP list configurations for high-performance IP matching",
            "patternProperties": {
                "^[a-zA-Z0-9_-]+$": {
                    "$ref": "#/definitions/ip_list"
                }
            },
            "additionalProperties": false
        },
        "ip_list": {
            "type": "object",
            "description": "Configuration for a single IP list",
            "properties": {
                "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "URL to fetch IP list from (one IP or CIDR per line)"
                },
                "name": {
                    "type": "string",
                    "description": "Human-readable name for the IP list"
                },
                "path": {
                    "type": "string",
                    "description": "Local file path to load IP list from (one IP or CIDR per line)"
                },
                "confidence": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Minimum confidence level (0-100) for IP list entries contained in this list"
                },
                "refresh_interval_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "description": "How often to refresh the list from URL in seconds"
                }
            },
            "oneOf": [
                {
                    "required": [
                        "url"
                    ]
                },
                {
                    "required": [
                        "path"
                    ]
                }
            ],
            "additionalProperties": false
        },
        "realtime_config": {
            "type": "object",
            "description": "WebSocket configuration for real-time messaging",
            "properties": {
                "key": {
                    "type": "string",
                    "description": "WebSocket application key"
                },
                "host": {
                    "type": "string",
                    "description": "Host for the WebSocket server"
                },
                "port": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 65535,
                    "description": "Port for the WebSocket server"
                },
                "channel": {
                    "type": "string",
                    "description": "Channel name to subscribe to for config update notifications (can be public or private)"
                },
                "auth_url": {
                    "type": "string",
                    "format": "uri",
                    "description": "Authentication URL for private channel access. Required for private channels"
                },
                "encrypted": {
                    "type": "boolean",
                    "description": "Whether to use encrypted WebSocket connections (WSS instead of WS). Default: true"
                }
            },
            "required": [
                "key",
                "host",
                "port",
                "channel"
            ],
            "additionalProperties": false
        },
        "ip_database_config": {
            "type": "object",
            "description": "IP geolocation database configuration",
            "properties": {
                "url": {
                    "type": "string",
                    "format": "uri",
                    "description": "URL to download the IP database from"
                },
                "refresh_interval_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "description": "How often to refresh the database in seconds"
                }
            },
            "required": [
                "url"
            ],
            "additionalProperties": false
        },
        "updates_config": {
            "type": "object",
            "description": "Configuration for remote package upgrades via WebSocket",
            "properties": {
                "allow_unattended": {
                    "type": "boolean",
                    "description": "Allow the FlowGuard control panel to trigger unattended package upgrades via WebSocket. Default: false"
                }
            },
            "additionalProperties": false
        },
        "trusted_proxies_config": {
            "type": "object",
            "description": "Trusted proxy configuration for X-Forwarded-For processing",
            "properties": {
                "ipnets": {
                    "type": "array",
                    "description": "List of trusted proxy networks (CIDR notation or URLs)",
                    "items": {
                        "type": "string",
                        "oneOf": [
                            {
                                "pattern": "^https?://",
                                "description": "URL to fetch IP ranges from"
                            },
                            {
                                "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}(/[0-9]{1,2})?$",
                                "description": "IPv4 address or CIDR"
                            },
                            {
                                "pattern": "^[0-9a-fA-F:]+(/[0-9]{1,3})?$",
                                "description": "IPv6 address or CIDR"
                            }
                        ]
                    }
                },
                "refresh_interval_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "description": "How often to refresh IP lists from URLs in seconds"
                }
            },
            "required": [
                "ipnets"
            ],
            "additionalProperties": false
        }
    }
}
